{% extends "base.html" %}

{% block title %}æˆå°±æŸ¥è©¢{% endblock %}

{% block content %}
<h2>
  {% if language == "ja" %}
    Steamã‚²ãƒ¼ãƒ ã®å®Ÿç¸¾ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’æ¤œç´¢
  {% elif language == "zh-tw" %}
    æŸ¥è©¢ Steam éŠæˆ²æˆå°±è¶¨å‹¢
  {% else %}
    Search Steam Game Achievement Trends
  {% endif %}
</h2>

<form method="get" action="/achievement" id="appidForm">
  <label for="appid">
    {% if language == "ja" %}
      AppID ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼š
    {% elif language == "zh-tw" %}
      è«‹è¼¸å…¥ AppIDï¼š
    {% else %}
      Enter AppID:
    {% endif %}
  </label>
  <input type="text" name="appid" id="appid" required placeholder="3123410">
  <button type="submit">
    {% if language == "ja" %}æ¤œç´¢{% elif language == "zh-tw" %}æŸ¥è©¢{% else %}Search{% endif %}
  </button>

  <p id="manualLoading" style="display:none; color: gray; font-size: 0.9em;">
    â³ {% if language == "ja" %}ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...{% elif language == "zh-tw" %}æ­£åœ¨æŸ¥è©¢è³‡æ–™ï¼Œè«‹ç¨å€™...{% else %}Loading data, please wait...{% endif %}
  </p>
</form>

<hr>

<label for="selectAppid">
  {% if language == "ja" %}æ‰€æŒã—ã¦ã„ã‚‹ã‚²ãƒ¼ãƒ ã‹ã‚‰æ¤œç´¢ï¼š{% elif language == "zh-tw" %}æˆ–å¾å·²æ“æœ‰çš„éŠæˆ²ä¸­è¨­æœå°‹æ¢ä»¶ï¼š{% else %}Or search from your owned games:{% endif %}
</label>
<p style="font-size: 0.9em; color: gray;">
  {% if language == "ja" %}é¸æŠã™ã‚‹ã¨è‡ªå‹•çš„ã«å®Ÿç¸¾ãƒšãƒ¼ã‚¸ã«ç§»å‹•ã—ã¾ã™ã€‚Steam ã®å¿œç­”ã‚’ãŠå¾…ã¡ãã ã•ã„{% elif language == "zh-tw" %}é¸æ“‡å¾Œæœƒè‡ªå‹•è·³è½‰è‡³æˆå°±æŸ¥è©¢é é¢ï¼Œè«‹è€å¿ƒç­‰ Steam å›æ‡‰{% else %}Selecting will auto redirect. Please wait for Steam to respond.{% endif %}
</p>

<input type="text" id="gameSearch" placeholder="{% if language == "ja" %}ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢{% elif language == "zh-tw" %}è¼¸å…¥é—œéµå­—æœå°‹éŠæˆ²...{% else %}Search games...{% endif %}" style="width:100%; padding:5px; margin-bottom: 8px;">
<select id="selectAppid" style="width:100%;">
  <option selected disabled>ğŸ”„ {% if language == "ja" %}ã‚²ãƒ¼ãƒ ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...{% elif language == "zh-tw" %}è¼‰å…¥éŠæˆ²åˆ—è¡¨ä¸­...{% else %}Loading game list...{% endif %}</option>
</select>
<p id="loadingMessage" style="display:none; color: gray; font-size: 0.9em;">
  â³ {% if language == "ja" %}ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...{% elif language == "zh-tw" %}æ­£åœ¨æŸ¥è©¢è³‡æ–™ï¼Œè«‹ç¨å€™...{% else %}Loading data, please wait...{% endif %}
</p>

<div id="coverPreview" style="margin-top: 10px;"></div>
{% endblock %}

{% block extra_script %}
<script>
window.addEventListener("pageshow", () => {
  document.getElementById("loadingMessage").style.display = "none";
  document.getElementById("manualLoading").style.display = "none";
});

fetch("/cached-games")
  .then(res => res.json())
  .then(games => {
    const select = document.getElementById("selectAppid");
    const search = document.getElementById("gameSearch");
    const loadingMsg = document.getElementById("loadingMessage");

    function renderOptions(keyword = "") {
      select.innerHTML = '<option value="">-- {% if language == "ja" %}ã‚²ãƒ¼ãƒ ã‚’é¸æŠ{% elif language == "zh-tw" %}é¸æ“‡ä¸€æ¬¾éŠæˆ²{% else %}Select a game{% endif %} --</option>';
      games.forEach(g => {
        if (g.name.toLowerCase().includes(keyword.toLowerCase())) {
          const opt = document.createElement("option");
          opt.value = g.appid;
          opt.textContent = `${g.name} (${g.appid})`;
          select.appendChild(opt);
        }
      });
    }

    renderOptions();

    search.addEventListener("input", e => {
      renderOptions(e.target.value);
    });

    select.addEventListener("input", function () {
      const selected = games.find(g => g.appid === this.value);
      if (selected) {
        select.disabled = true;
        search.disabled = true;
        loadingMsg.style.display = "block";
        window.location.href = `/achievement/${this.value}?lang={{ language }}`;
      }
    });
  })
  .catch(err => {
    const select = document.getElementById("selectAppid");
    select.innerHTML = '<option disabled selected>âš ï¸ {% if language == "ja" %}èª­ã¿è¾¼ã¿å¤±æ•—{% elif language == "zh-tw" %}è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦{% else %}Failed to load, please try again{% endif %}</option>';
    console.error("è¼‰å…¥ cached-games å¤±æ•—ï¼š", err);
  });

document.getElementById("appidForm").addEventListener("submit", function () {
  document.getElementById("manualLoading").style.display = "block";
});
</script>
{% endblock %}
