{% extends "base.html" %}

{% block title %}成就查詢{% endblock %}

{% block content %}
<h2>查詢 Steam 遊戲成就趨勢</h2>
<form method="get" action="/achievement">
    <label for="appid">請輸入 AppID：</label>
    <input type="text" name="appid" id="appid" required placeholder="例如 3123410">
    <button type="submit">查詢</button>

    <hr>

    <label for="selectAppid">或從已擁有的遊戲中搜尋：</label>
    <input type="text" id="gameSearch" placeholder="輸入關鍵字搜尋遊戲..." style="width:100%; padding:5px; margin-bottom: 8px;">
    <select id="selectAppid" style="width:100%;">
        <option value="">-- 選擇一款遊戲 --</option>
    </select>
    <div id="coverPreview" style="margin-top: 10px;"></div>
</form>

<script>
fetch("/cached-games")
    .then(res => res.json())
    .then(games => {
        const select = document.getElementById("selectAppid");
        const search = document.getElementById("gameSearch");
        const preview = document.getElementById("coverPreview");

        function renderOptions(keyword = "") {
            select.innerHTML = '<option value="">-- 選擇一款遊戲 --</option>';
            games.forEach(g => {
                const allNames = Object.values(g.names || {}).join(" | ");
                if (allNames.toLowerCase().includes(keyword.toLowerCase())) {
                    const opt = document.createElement("option");
                    opt.value = g.appid;
                    opt.textContent = `${allNames} (${g.appid})`;
                    select.appendChild(opt);
                }
            });
        }

        renderOptions();

        search.addEventListener("input", e => {
            renderOptions(e.target.value);
        });

        select.addEventListener("change", function () {
            const selected = games.find(g => g.appid === this.value);
            if (selected) {
                preview.innerHTML = selected.header ? `<img src="${selected.header}" alt="封面圖" style="max-width:100%; border-radius:8px;">` : "";
                location.href = `/achievement/${this.value}?lang=zh-tw`;
            } else {
                preview.innerHTML = "";
            }
        });
    });
</script>
{% endblock %}
