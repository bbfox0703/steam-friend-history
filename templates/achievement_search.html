{% extends "base.html" %}

{% block title %}æˆå°±æŸ¥è©¢{% endblock %}

{% block content %}
<h2>æŸ¥è©¢ Steam éŠæˆ²æˆå°±è¶¨å‹¢</h2>

<form method="get" action="/achievement" id="appidForm">
    <label for="appid">è«‹è¼¸å…¥ AppIDï¼š</label>
    <input type="text" name="appid" id="appid" required placeholder="ä¾‹å¦‚ 3123410">
    <button type="submit">æŸ¥è©¢</button>

    <p id="manualLoading" style="display:none; color: gray; font-size: 0.9em;">â³ æ­£åœ¨æŸ¥è©¢è³‡æ–™ï¼Œè«‹ç¨å€™...</p>
</form>

<hr>

<label for="selectAppid">æˆ–å¾å·²æ“æœ‰çš„éŠæˆ²ä¸­è¨­æœå°‹æ¢ä»¶ï¼š</label>
<p style="font-size: 0.9em; color: gray;">é¸æ“‡å¾Œæœƒè‡ªå‹•è·³è½‰è‡³æˆå°±æŸ¥è©¢é é¢ï¼Œè«‹è€å¿ƒç­‰ Steam å›æ‡‰</p>

<input type="text" id="gameSearch" placeholder="è¼¸å…¥é—œéµå­—æœå°‹éŠæˆ²..." style="width:100%; padding:5px; margin-bottom: 8px;">
<select id="selectAppid" style="width:100%;">
    <option selected disabled>ğŸ”„ è¼‰å…¥éŠæˆ²åˆ—è¡¨ä¸­...</option>
</select>
<p id="loadingMessage" style="display:none; color: gray; font-size: 0.9em;">â³ æ­£åœ¨æŸ¥è©¢è³‡æ–™ï¼Œè«‹ç¨å€™...</p>

<div id="coverPreview" style="margin-top: 10px;"></div>
{% endblock %}

{% block extra_script %}
<script>
window.addEventListener("pageshow", () => {
    document.getElementById("loadingMessage").style.display = "none";
    document.getElementById("manualLoading").style.display = "none";
});

fetch("/cached-games")
    .then(res => res.json())
    .then(games => {
        const select = document.getElementById("selectAppid");
        const search = document.getElementById("gameSearch");
        const loadingMsg = document.getElementById("loadingMessage");

        function renderOptions(keyword = "") {
            select.innerHTML = '<option value="">-- é¸æ“‡ä¸€æ¬¾éŠæˆ² --</option>';
            games.forEach(g => {
                if (g.name.toLowerCase().includes(keyword.toLowerCase())) {
                    const opt = document.createElement("option");
                    opt.value = g.appid;
                    opt.textContent = `${g.name} (${g.appid})`;
                    select.appendChild(opt);
                }
            });
        }

        renderOptions();

        search.addEventListener("input", e => {
            renderOptions(e.target.value);
        });

        select.addEventListener("input", function () {
            const selected = games.find(g => g.appid === this.value);
            if (selected) {
                select.disabled = true;
                search.disabled = true;
                loadingMsg.style.display = "block";
                window.location.href = `/achievement/${this.value}?lang=zh-tw`;
            }
        });
    })
    .catch(err => {
        const select = document.getElementById("selectAppid");
        select.innerHTML = '<option disabled selected>âš ï¸ è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦</option>';
        console.error("è¼‰å…¥ cached-games å¤±æ•—ï¼š", err);
    });

	document.getElementById("appidForm").addEventListener("submit", function () {
		document.getElementById("manualLoading").style.display = "block";
		
	window.addEventListener("pageshow", () => {
		const m = document.getElementById("manualLoading");
		const l = document.getElementById("loadingMessage");
		if (m) m.style.display = "none";
		if (l) l.style.display = "none";
	});

	document.addEventListener("visibilitychange", () => {
		if (document.visibilityState === "visible") {
			const m = document.getElementById("manualLoading");
			const l = document.getElementById("loadingMessage");
			if (m) m.style.display = "none";
			if (l) l.style.display = "none";
		}
	});
	
});
</script>
{% endblock %}

