{% extends "base.html" %}
{% block content %}

<h1>{{ _('成就及遊玩時間總趨勢') }}</h1>

<!-- 🔥 成就趨勢 Toggle 控制器 -->
<div style="margin-bottom: 10px;">
  <label>
    <input type="checkbox" id="firstZeroToggle">
    {{ _('第一筆成就趨勢強制為0') }}
  </label>
</div>

<!-- 🔥 成就趨勢圖表 -->
<canvas id="achievementChart" height="100"></canvas>

<!-- 🔥 遊玩時間趨勢圖表 -->
<canvas id="playtimeChart" height="100" style="margin-top: 50px;"></canvas>

<div>
  <label>{{ _('顯示單位變更') }}:</label>
  <select id="modeSelect">
    <option value="day">{{ _('天') }}</option>
    <option value="month">{{ _('月') }}</option>
    <option value="year">{{ _('年') }}</option>
  </select>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let achievementChartInstance = null;
let playtimeChartInstance = null;

const achievements = {{ achievements|tojson }};
const playtimes = {{ playtimes|tojson }};
let mode = '{{ mode }}';

function processDailyChange(data, granularity, forceZeroFirstPoint = true) {
  const sortedDates = Object.keys(data).sort();
  const result = {};
  let prevTotal = 0;
  let isFirst = true;

  for (const date of sortedDates) {
    let key = date;
    if (granularity === 'month') key = date.slice(0, 7);
    else if (granularity === 'year') key = date.slice(0, 4);

    const appData = data[date];
    let todayTotal = 0;
    for (const appid in appData) {
      todayTotal += appData[appid];
    }

    const diff = todayTotal - prevTotal;

    if (!(key in result)) result[key] = 0;

    if (isFirst) {
      if (forceZeroFirstPoint) {
        result[key] = 0;
      } else {
        result[key] = diff;
      }
      isFirst = false;
    } else {
      result[key] += diff;
    }

    prevTotal = todayTotal;
  }

  return result;
}

function drawAchievementTrend(forceZeroFirstPoint = true) {
  const dailyData = processDailyChange(achievements, mode, forceZeroFirstPoint);
  const labels = Object.keys(dailyData);
  const data = Object.values(dailyData);

  if (achievementChartInstance) {
    achievementChartInstance.destroy();
  }

  const ctx = document.getElementById('achievementChart').getContext('2d');
  achievementChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '{{ _('每日成就增量') }}',
        data: data,
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

function drawPlaytimeTrend() {
  const dailyData = processDailyChange(playtimes, mode, true);
  const labels = Object.keys(dailyData);
  const data = Object.values(dailyData);

  if (playtimeChartInstance) {
    playtimeChartInstance.destroy();
  }

  const ctx = document.getElementById('playtimeChart').getContext('2d');
  playtimeChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '{{ _('每日遊玩時間變化') }}',
        data: data,
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true
        }
      }
    }
  });
}

window.addEventListener('DOMContentLoaded', function() {
  const toggle = document.getElementById('firstZeroToggle');
  const savedToggle = localStorage.getItem('forceZeroFirstPoint');
  if (savedToggle !== null) {
    toggle.checked = savedToggle === 'true';
  } else {
    toggle.checked = true;
  }

  drawAchievementTrend(toggle.checked);
  drawPlaytimeTrend();

  toggle.addEventListener('change', function() {
    const forceZero = this.checked;
    localStorage.setItem('forceZeroFirstPoint', forceZero);
    drawAchievementTrend(forceZero);
  });

  document.getElementById('modeSelect').addEventListener('change', function() {
    mode = this.value;
    drawAchievementTrend(document.getElementById('firstZeroToggle').checked);
    drawPlaytimeTrend();
  });
});
</script>

{% endblock %}
