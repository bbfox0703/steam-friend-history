{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2>{{ _('成就總趨勢') }}</h2>

  <div>
    <label for="granularity">{{ _('時間粒度') }}:</label>
    <select id="granularity" onchange="updateCharts()">
      <option value="day">{{ _('日') }}</option>
      <option value="month">{{ _('月') }}</option>
      <option value="year">{{ _('年') }}</option>
    </select>
  </div>

  <div style="margin-top: 20px;">
    <h3>{{ _('成就成長趨勢') }} ({{ _('每日新增') }})</h3>
    <canvas id="achievementChart" width="400" height="200"></canvas>
  </div>

  <div style="margin-top: 40px;">
    <h3>{{ _('遊玩時間成長趨勢') }} ({{ _('每日新增') }})</h3>
    <canvas id="playtimeChart" width="400" height="200"></canvas>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const rawAchievements = {{ achievements | tojson }};
const rawPlaytimes = {{ playtimes | tojson }};

let achievementChart, playtimeChart;

function processDailyChange(data, granularity) {
  const sortedDates = Object.keys(data).sort();
  const result = {};
  let prevTotals = {};

  for (const date of sortedDates) {
    let key = date;
    if (granularity === 'month') {
      key = date.slice(0, 7);
    } else if (granularity === 'year') {
      key = date.slice(0, 4);
    }

    let total = 0;
    const appData = data[date];
    for (const appid in appData) {
      total += appData[appid];
    }

    if (!(key in result)) {
      result[key] = 0;
    }

    if (prevTotals[key] !== undefined) {
      const diff = total - prevTotals[key];
      result[key] += diff;
    }
    prevTotals[key] = total;
  }

  return result;
}

function drawChart(canvasId, chartRef, label, data, color) {
  const ctx = document.getElementById(canvasId).getContext('2d');
  if (chartRef) {
    chartRef.destroy();
  }

  const labels = Object.keys(data).sort();
  const values = labels.map(k => data[k]);

  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: label,
        data: values,
        fill: false,
        borderColor: color,
        tension: 0.1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function updateCharts() {
  const granularity = document.getElementById('granularity').value;
  const processedAchievements = processDailyChange(rawAchievements, granularity);
  const processedPlaytimes = processDailyChange(rawPlaytimes, granularity);

  achievementChart = drawChart('achievementChart', achievementChart, '{{ _("成就成長趨勢") }} ({{ _("每日新增") }})', processedAchievements, 'blue');
  playtimeChart = drawChart('playtimeChart', playtimeChart, '{{ _("遊玩時間成長趨勢") }} ({{ _("每日新增") }})', processedPlaytimes, 'green');
}

// 初次載入
updateCharts();
</script>
{% endblock %}
