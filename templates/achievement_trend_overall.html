{% extends "base.html" %}

{% block content %}

<h1>{{ _('成就及遊玩時間總趨勢') }}</h1>

<!-- 顯示單位切換 -->
<div class="toggle-buttons" style="margin-bottom: 15px;">
  <span>{{ _('顯示單位') }}：</span>
  <a href="javascript:void(0);" id="modeDay" class="mode-btn">{{ _('日') }}</a>
  <a href="javascript:void(0);" id="modeMonth" class="mode-btn">{{ _('月') }}</a>
  <a href="javascript:void(0);" id="modeYear" class="mode-btn">{{ _('年') }}</a>
</div>

<!-- 成就趨勢 Toggle 控制器 -->
<div style="margin-bottom: 20px;">
  <label>
    <input type="checkbox" id="firstZeroToggle">
    {{ _('第一筆成就趨勢強制為0') }}
  </label>
</div>

<!-- 成就趨勢圖表 -->
<canvas id="achievementChart" height="100"></canvas>

<!-- 遊玩時間趨勢圖表 -->
<canvas id="playtimeChart" height="100" style="margin-top: 50px;"></canvas>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let achievementChartInstance = null;
let playtimeChartInstance = null;

const achievements = {{ achievements|tojson }};
const playtimes = {{ playtimes|tojson }};
let mode = '{{ mode }}';

function processDailyChange(data, granularity, forceZeroFirstPoint = true) {
  const sortedDates = Object.keys(data).sort();
  const result = {};
  let prevTotal = null;
  let isFirst = true;

  for (const date of sortedDates) {
    let key = date;
    if (granularity === 'month') key = date.slice(0, 7);
    else if (granularity === 'year') key = date.slice(0, 4);

    const appData = data[date] || {};
    let todayTotal = 0;
    for (const appid in appData) {
      todayTotal += appData[appid];
    }

    if (todayTotal === 0 && prevTotal === null) {
      continue;
    }

    let diff = 0;
    if (prevTotal === null) {
      diff = todayTotal;
    } else {
      diff = todayTotal - prevTotal;
    }

    if (!(key in result)) result[key] = 0;

    if (isFirst) {
      if (forceZeroFirstPoint) {
        result[key] = 0;
      } else {
        result[key] = diff;
      }
      isFirst = false;
    } else {
      result[key] += diff;
    }

    prevTotal = todayTotal;
  }

  return result;
}

function drawAchievementTrend(forceZeroFirstPoint = true) {
  const dailyData = processDailyChange(achievements, mode, forceZeroFirstPoint);
  const labels = Object.keys(dailyData);
  const data = Object.values(dailyData);

  if (achievementChartInstance) achievementChartInstance.destroy();

  const ctx = document.getElementById('achievementChart').getContext('2d');
  achievementChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '{{ _('成就趨勢') }}',
        data: data,
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function drawPlaytimeTrend() {
  const dailyData = processDailyChange(playtimes, mode, true);
  const labels = Object.keys(dailyData);
  const data = Object.values(dailyData);

  if (playtimeChartInstance) playtimeChartInstance.destroy();

  const ctx = document.getElementById('playtimeChart').getContext('2d');
  playtimeChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: '{{ _('每日新增遊玩時間（分鐘）') }}',
        data: data,
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function updateCharts() {
  const forceZero = document.getElementById('firstZeroToggle').checked;
  drawAchievementTrend(forceZero);
  drawPlaytimeTrend();
}

window.addEventListener('DOMContentLoaded', function() {
  const toggle = document.getElementById('firstZeroToggle');
  const savedToggle = localStorage.getItem('forceZeroFirstPoint');

  if (savedToggle !== null) {
    toggle.checked = savedToggle === 'true';
  } else {
    toggle.checked = true;
  }

  updateCharts();

  toggle.addEventListener('change', function() {
    localStorage.setItem('forceZeroFirstPoint', this.checked);
    updateCharts();
  });

  document.getElementById('modeDay').addEventListener('click', () => { mode = 'day'; updateCharts(); updateActiveMode(); });
  document.getElementById('modeMonth').addEventListener('click', () => { mode = 'month'; updateCharts(); updateActiveMode(); });
  document.getElementById('modeYear').addEventListener('click', () => { mode = 'year'; updateCharts(); updateActiveMode(); });

  updateActiveMode();
});

function updateActiveMode() {
  document.getElementById('modeDay').classList.remove('active');
  document.getElementById('modeMonth').classList.remove('active');
  document.getElementById('modeYear').classList.remove('active');

  if (mode === 'day') document.getElementById('modeDay').classList.add('active');
  else if (mode === 'month') document.getElementById('modeMonth').classList.add('active');
  else if (mode === 'year') document.getElementById('modeYear').classList.add('active');
}
</script>

<style>
.mode-btn {
  padding: 6px 12px;
  border: 1px solid #ccc;
  margin: 0 4px;
  text-decoration: none;
  color: #000;
  border-radius: 4px;
}
.mode-btn.active {
  background-color: #007bff;
  color: white;
}
</style>

{% endblock %}
