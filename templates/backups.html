{% extends "base.html" %}

{% block title %}備份管理{% endblock %}

{% block content %}
<h1>備份管理</h1>

<p>排序：
    {% set toggle_order = 'asc' if order == 'desc' else 'desc' %}
    <a href="?sort=name&order={{ 'asc' if sort_by != 'name' else toggle_order }}">名稱</a> |
    <a href="?sort=size_kb&order={{ 'asc' if sort_by != 'size_kb' else toggle_order }}">大小</a> |
    <a href="?sort=mtime&order={{ 'asc' if sort_by != 'mtime' else toggle_order }}">時間</a>
</p>

<form id="zip-form" method="post" action="/backups/zip">
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>檔名</th>
                <th>大小 (KB)</th>
                <th>建立時間</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
        {% for file in files %}
            <tr>
                <td><input type="checkbox" name="files" value="{{ file.name }}"></td>
                <td>{{ file.name }}</td>
                <td>{{ file.size_kb }}</td>
                <td><time class="datetime-auto" data-timestamp="{{ file.mtime }}">{{ file.mtime | datetimeformat }}</time></td>
                <td>
                    <a href="/backups/download/{{ file.name }}">下載</a> |
                    <a href="#" onclick="deleteBackup('{{ file.name }}'); return false;">刪除</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if files|length > 0 %}
    <p>
        <button type="submit">📦 匯出選取為 ZIP</button>
    </p>
    {% else %}
    <p>尚無備份檔案。</p>
    {% endif %}
</form>
{% endblock %}

{% block extra_script %}
<script>
function deleteBackup(filename) {
    if (!confirm('確定要刪除 ' + filename + ' 嗎？')) return;
    fetch('/backups/delete/' + filename, { method: 'POST' })
        .then(res => res.json())
        .then(result => {
            if (result.status === 'deleted') {
                location.reload();
            } else {
                alert('找不到檔案或刪除失敗');
            }
        });
}

document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="files"]');
    for (const cb of checkboxes) cb.checked = this.checked;
});
</script>
{% endblock %}
