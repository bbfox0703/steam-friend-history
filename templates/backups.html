{% extends "base.html" %}

{% block title %}å‚™ä»½ç®¡ç†{% endblock %}

{% block content %}
<h1>å‚™ä»½ç®¡ç†</h1>

<p>æ’åºï¼š
    {% set toggle_order = 'asc' if order == 'desc' else 'desc' %}
    <a href="?sort=name&order={{ 'asc' if sort_by != 'name' else toggle_order }}">åç¨±</a> |
    <a href="?sort=size_kb&order={{ 'asc' if sort_by != 'size_kb' else toggle_order }}">å¤§å°</a> |
    <a href="?sort=mtime&order={{ 'asc' if sort_by != 'mtime' else toggle_order }}">æ™‚é–“</a>
</p>

<form id="zip-form" method="post" action="/backups/zip">
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>æª”å</th>
                <th>å¤§å° (KB)</th>
                <th>å»ºç«‹æ™‚é–“</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
        {% for file in files %}
            <tr>
                <td><input type="checkbox" name="files" value="{{ file.name }}"></td>
                <td>{{ file.name }}</td>
                <td>{{ file.size_kb }}</td>
                <td><time class="datetime-auto" data-timestamp="{{ file.mtime }}">{{ file.mtime | datetimeformat }}</time></td>
                <td>
                    <a href="/backups/download/{{ file.name }}">ä¸‹è¼‰</a> |
                    <a href="#" onclick="deleteBackup('{{ file.name }}'); return false;">åˆªé™¤</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if files|length > 0 %}
    <p>
        <button type="submit">ğŸ“¦ åŒ¯å‡ºé¸å–ç‚º ZIP</button>
    </p>
    {% else %}
    <p>å°šç„¡å‚™ä»½æª”æ¡ˆã€‚</p>
    {% endif %}
</form>
{% endblock %}

{% block extra_script %}
<script>
function deleteBackup(filename) {
    if (!confirm('ç¢ºå®šè¦åˆªé™¤ ' + filename + ' å—ï¼Ÿ')) return;
    fetch('/backups/delete/' + filename, { method: 'POST' })
        .then(res => res.json())
        .then(result => {
            if (result.status === 'deleted') {
                location.reload();
            } else {
                alert('æ‰¾ä¸åˆ°æª”æ¡ˆæˆ–åˆªé™¤å¤±æ•—');
            }
        });
}

document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="files"]');
    for (const cb of checkboxes) cb.checked = this.checked;
});
</script>
{% endblock %}
