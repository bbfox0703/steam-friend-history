{% extends "base.html" %}

{% block title %}{{ _('å‚™ä»½ç®¡ç†') }}{% endblock %}

{% block content %}
<h2>{{ _('å‚™ä»½ç®¡ç†') }}</h2>

<p>{{ _('æ’åºï¼š') }}
    {% set toggle_order = 'asc' if order == 'desc' else 'desc' %}
    <a href="?sort=name&order={{ 'asc' if sort_by != 'name' else toggle_order }}">{{ _('åç¨±') }}</a> |
    <a href="?sort=size_kb&order={{ 'asc' if sort_by != 'size_kb' else toggle_order }}">{{ _('å¤§å°') }}</a> |
    <a href="?sort=mtime&order={{ 'asc' if sort_by != 'mtime' else toggle_order }}">{{ _('æ™‚é–“') }}</a>
</p>

<form id="zip-form" method="post" action="/backups/zip">
    <table>
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all"></th>
                <th>{{ _('æª”å') }}</th>
                <th>{{ _('å¤§å° (KB)') }}</th>
                <th>{{ _('å»ºç«‹æ™‚é–“') }}</th>
                <th>{{ _('æ“ä½œ') }}</th>
            </tr>
        </thead>
        <tbody>
        {% for file in files %}
            <tr>
                <td><input type="checkbox" name="files" value="{{ file.name }}"></td>
                <td>{{ file.name }}</td>
                <td>{{ file.size_kb }}</td>
                <td><time class="datetime-auto" data-timestamp="{{ file.mtime }}">{{ file.mtime | datetimeformat }}</time></td>
                <td>
                    <a href="/backups/download/{{ file.name }}">{{ _('ä¸‹è¼‰') }}</a> |
                    <a href="#" onclick="deleteBackup('{{ file.name }}'); return false;">{{ _('åˆªé™¤') }}</a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    {% if files|length > 0 %}
    <p>
        <button type="submit">ğŸ“¦ {{ _('åŒ¯å‡ºé¸å–ç‚º ZIP') }}</button>
    </p>
    {% else %}
    <p>{{ _('å°šç„¡å‚™ä»½æª”æ¡ˆã€‚') }}</p>
    {% endif %}
</form>
{% endblock %}

{% block extra_script %}
<script>
function deleteBackup(filename) {
    if (!confirm('{{ _("ç¢ºå®šè¦åˆªé™¤") }} ' + filename + ' {{ _("å—ï¼Ÿ") }}')) return;
    fetch('/backups/delete/' + filename, { method: 'POST' })
        .then(res => res.json())
        .then(result => {
            if (result.status === 'deleted') {
                location.reload();
            } else {
                alert('{{ _("æ‰¾ä¸åˆ°æª”æ¡ˆæˆ–åˆªé™¤å¤±æ•—") }}');
            }
        });
}

document.getElementById('select-all').addEventListener('change', function() {
    const checkboxes = document.querySelectorAll('input[name="files"]');
    for (const cb of checkboxes) cb.checked = this.checked;
});

function formatLocalTime(ts) {
    const date = new Date(ts * 1000);
    return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hourCycle: 'h23'
    });
}

function formatDaysAgo(ts) {
    const now = new Date();
    const then = new Date(ts * 1000);
    const diffDays = Math.floor((now - then) / 86400000);
    return `${diffDays} {{ _('å¤©å‰') }}`;
}

function updateAllTimestamps() {
    document.querySelectorAll('.datetime-auto').forEach(el => {
        const ts = parseInt(el.dataset.timestamp, 10);
        if (!isNaN(ts)) {
            el.innerText = formatLocalTime(ts) + 'ï¼ˆ' + formatDaysAgo(ts) + 'ï¼‰';
        }
    });
}

updateAllTimestamps();
</script>
{% endblock %}
