<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}{{ _('Steam 好友工具') }}{% endblock %}</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    {% block extra_head %}{% endblock %}
</head>
<body class="main-body">

    <div class="menu-bar">
        <a href="/" class="menu-link">{{ _('好友清單') }}</a>
        <a href="/history" class="menu-link">{{ _('變更紀錄') }}</a>
        <a href="/trend" class="menu-link">{{ _('好友趨勢圖') }}</a>
		<!--
        <a href="/status-board" class="menu-link">{{ _('好友狀態看板') }}</a>
		-->
        <a href="/filter" class="menu-link">{{ _('條件篩選') }}</a>
        <a href="/country" class="menu-link">{{ _('國別分析') }}</a>
        <a href="/country-chart" class="menu-link">{{ _('國別統計圖') }}</a>
        <a href="/achievement" class="menu-link">{{ _('成就查詢') }}</a>
        <a href="/achievement-trend-overall" class="menu-link">{{ _('成就及遊玩時間總趨勢') }}</a>
        <a href="/game-playtime-search" class="menu-link">{{ _('遊玩時間趨勢') }}</a>
        <a href="/games-trend" class="menu-link">{{ _('持有遊戲數趨勢') }}</a>
        <a href="/level-trend" class="menu-link">{{ _('等級趨勢圖') }}</a>
        <a href="/level-history" class="menu-link">{{ _('等級變化紀錄') }}</a>
        <a href="/backups" class="menu-link">{{ _('備份管理') }}</a>
        <a href="/update" class="menu-link">{{ _('更新資料（背景有自動定期更新）') }}</a>

        <div class="language-switcher">
            <span class="lang-label">{{ _('語言') }}:</span>
            <select id="langSelect" class="lang-select">
                <option value="auto" {% if not request.cookies.get('lang_override') %}selected{% endif %}>{{ _('自動偵測') }}</option>
                <option value="zh-TW" {% if get_locale() == 'zh-TW' and request.cookies.get('lang_override') %}selected{% endif %}>{{ _('繁體中文') }}</option>
                <option value="en" {% if get_locale() == 'en' and request.cookies.get('lang_override') %}selected{% endif %}>{{ _('English') }}</option>
                <option value="ja" {% if get_locale() == 'ja' and request.cookies.get('lang_override') %}selected{% endif %}>{{ _('日本語') }}</option>
            </select>
        </div>
    </div>

    <div class="container">
        {% block content %}{% endblock %}
    </div>

    {% block extra_script %}
    <script>
    function getPreferredLang() {
        const langs = navigator.languages || [navigator.language || 'en'];
        for (const lang of langs) {
            const l = lang.toLowerCase();
            if (l.includes('zh-tw')) return 'zh-TW';
            if (l.includes('ja')) return 'ja';
        }
        return 'en';
    }
    document.documentElement.lang = getPreferredLang();

    function formatLocalTime(ts) {
        const date = new Date(ts * 1000);
        return date.toLocaleString(document.documentElement.lang, {
            year: 'numeric',
            month: 'numeric',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hourCycle: 'h23'
        });
    }
    function formatAgo(ts) {
        const now = new Date();
        const then = new Date(ts * 1000);
        const diff = Math.floor((now - then) / 1000);
        if (diff < 60) return `${diff} {{ _('秒前') }}`;
        if (diff < 3600) return `${Math.floor(diff / 60)} {{ _('分鐘前') }}`;
        if (diff < 86400) return `${Math.floor(diff / 3600)} {{ _('小時前') }}`;
        return `${Math.floor(diff / 86400)} {{ _('天前') }}`;
    }
    function updateAllTimestamps() {
        document.querySelectorAll('.datetime-auto').forEach(el => {
            const ts = parseInt(el.dataset.timestamp, 10);
            if (!isNaN(ts)) {
                el.innerText = formatLocalTime(ts) + '（' + formatAgo(ts) + '）';
            }
        });
    }
    document.addEventListener('DOMContentLoaded', updateAllTimestamps);

    // 語言切換功能
    document.addEventListener('DOMContentLoaded', function() {
        const langSelect = document.getElementById('langSelect');

        // 設定目前語言 - 優先使用服務器端的語言設定
        // 不依賴客戶端的偏好設定，因為這已經在服務器端處理了
        // langSelect.value 已在服務器端模板中設定

        // 語言變更事件
        langSelect.addEventListener('change', function() {
            const selectedLang = this.value;
            if (selectedLang === 'auto') {
                // 重置為自動偵測 - 清除 Cookie
                document.cookie = 'lang_override=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                window.location.reload();
            } else {
                window.location.href = `/set-language/${selectedLang}`;
            }
        });
    });

    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
    }
    </script>
    {% endblock %}

</body>
</html>
