{% extends "base.html" %}

{% block title %}好友條件篩選{% endblock %}

{% block content %}
<h1>Steam 好友條件篩選</h1>

<form id="filter-form" style="margin-bottom: 1em;">
	<label>加入時間排序：
		<select name="sort">
			<option value="newest" {% if request.args.get('sort') == 'newest' %}selected{% endif %}>最近優先</option>
			<option value="oldest" {% if request.args.get('sort') == 'oldest' %}selected{% endif %}>最早優先</option>
		</select>
	</label>
    <label><input type="checkbox" name="online_only" {% if request.args.get('online_only') %}checked{% endif %}> 只顯示在線上</label>
    <label><input type="checkbox" name="has_avatar" {% if request.args.get('has_avatar') %}checked{% endif %}> 有頭像</label>
    <label><input type="checkbox" name="has_country" {% if request.args.get('has_country') %}checked{% endif %}> 有國別</label>
    <label>最近幾天內有上線：
        <input type="number" name="recent_days" value="{{ request.args.get('recent_days', '') }}" min="1" max="365" style="width: 60px;">
    </label>
    <label>指定國家：
        <select name="country_code">
            <option value="">（不限）</option>
            {% for code in all_countries %}
                <option value="{{ code }}" {% if request.args.get('country_code') == code %}selected{% endif %}>{{ code }}</option>
            {% endfor %}
        </select>
    </label>
    <button type="submit">套用篩選</button>
</form>

<hr>

<ul class="friend-grid" id="friend-list">
    {% for friend in friends %}
    <li>
        <a class="friend-item" href="{{ friend.profile_url }}" target="_blank">
            <img src="{{ friend.avatar if friend.avatar else '/static/default-avatar.png' }}" alt="avatar">
            <div class="friend-info">
                <strong>{{ friend.persona_name if friend.persona_name else '[未知名稱]' }}</strong>
                <small>
                    加入於 
					<time class="datetime-auto" data-timestamp="{{ friend.friend_since }}">
						{{ friend.friend_since | datetimeformat }}
					</time><br>
                    狀態：{{ status_map.get(friend.personastate, '未知') }}<br>
                    {% if friend.lastlogoff %}
                        上次離線：{{ friend.lastlogoff | datetimeformat }}
                    {% endif %}
                    {% if friend.country_code %}
                        <br>國別：{{ friend.country_code }}
                    {% endif %}
                </small>
            </div>
        </a>
    </li>
    {% endfor %}
</ul>
{% endblock %}

{% block extra_script %}
<script>
const form = document.getElementById('filter-form');
const list = document.getElementById('friend-list');

const statusMap = {
    0: '離線',
    1: '在線上',
    2: '忙碌',
    3: '離開',
    4: '請勿打擾',
    5: '想交易',
    6: '想玩遊戲'
};

// ✅ 單一綁定 change（適用全部欄位）
form.addEventListener('change', fetchFiltered);

// ✅ submit 攔截也走同一條路
form.addEventListener('submit', e => {
    e.preventDefault();
    fetchFiltered();
});

function formatLocalTime(ts) {
    const date = new Date(ts * 1000);
    return date.toLocaleString('zh-TW', {
        year: 'numeric',
        month: 'numeric',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hourCycle: 'h23'
    });
}

function formatDaysAgo(ts) {
    const now = new Date();
    const then = new Date(ts * 1000);
    const diffDays = Math.floor((now - then) / 86400000);
    return `${diffDays} 天前`;
}

function updateAllTimestamps() {
    document.querySelectorAll('.datetime-auto').forEach(el => {
        const ts = parseInt(el.dataset.timestamp, 10);
        if (!isNaN(ts)) {
            el.innerText = formatLocalTime(ts) + '（' + formatDaysAgo(ts) + '）';
        }
    });
}

function fetchFiltered() {
    const params = new URLSearchParams(new FormData(form));
    fetch('/filter?' + params.toString(), {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.json())
    .then(data => {
        list.innerHTML = '';
        if (data.length === 0) {
            list.innerHTML = '<p>目前無符合條件的好友。</p>';
            return;
        }
        for (const f of data) {
            const li = document.createElement('li');
            li.innerHTML = `
                <a class="friend-item" href="${f.profile_url}" target="_blank">
                    <img src="${f.avatar || '/static/default-avatar.png'}" alt="avatar">
                    <div class="friend-info">
                        <strong>${f.persona_name || '[未知名稱]'}</strong>
                        <small>
                            加入於 <time class="datetime-auto" data-timestamp="${f.friend_since}">${formatLocalTime(f.friend_since)}（${formatDaysAgo(f.friend_since)}）</time><br>
                            狀態：${statusMap[f.personastate] || '未知'}<br>
                            ${f.lastlogoff ? '上次離線：' + new Date(f.lastlogoff * 1000).toLocaleString() + '<br>' : ''}
                            ${f.country_code ? '國別：' + f.country_code : ''}
                        </small>
                    </div>
                </a>
            `;
            list.appendChild(li);
        }
        updateAllTimestamps();
    });
}
</script>
{% endblock %}
