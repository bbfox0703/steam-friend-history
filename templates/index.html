{% extends "base.html" %}

{% block title %}{{ _('Steam å¥½å‹ç³»çµ±') }}{% endblock %}

{% block content %}    
<div class="container">
    <h2>{{ _('Steam å¥½å‹ç³»çµ±') }}</h2>
    {% if data %}
    <ul class="friend-list">
        {% for friend in data %}
        <li class="friend-item" {% if friend.incomplete %}style="opacity: 0.5;" title="{{ _('è³‡æ–™ä¸å®Œæ•´ï¼šå¯èƒ½ç¼ºå°‘åç¨±æˆ–é ­åƒ') }}"{% endif %}>
            <a href="{{ friend.profile_url }}" target="_blank" style="display:flex; text-decoration:none; color:inherit;">
                <img src="{{ friend.avatar if friend.avatar else '/static/default-avatar.png' }}" alt="avatar">
				<div class="friend-info">
					<strong>
						{{ friend.persona_name or _('ã€æœªçŸ¥åç¨±ã€‘') }}
						{% if friend.incomplete %}<span style="color: red;">ï¼ˆ{{ _('ä¸å®Œæ•´') }}ï¼‰</span>{% endif %}
					</strong><br>
					<small>
						{{ _('åŠ å…¥æ–¼') }} 
						<time class="datetime-auto" data-timestamp="{{ friend.friend_since }}" title="{{ friend.friend_since | datetimeformat }}">
							{{ friend.friend_since | datetimeformat }}
						</time><br>
						{% if friend.level is defined and friend.level is not none %}
							{{ _('ç­‰ç´šï¼š') }}{{ friend.level }}
						{% endif %}
					</small>
				</div>
            </a>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>{{ _('ç›®å‰å°šç„¡å¥½å‹è³‡æ–™ï¼Œè«‹å…ˆå‰å¾€') }} <code>/update</code> {{ _('æ›´æ–°ã€‚') }}</p>
    {% endif %}
</div>
{% endblock %}

{% block extra_script %}
<script>
document.addEventListener("DOMContentLoaded", () => {
    const lang = document.documentElement.lang || 'zh-TW';

    // ğŸ•’ å°‡ UNIX timestamp æ ¼å¼åŒ–
    document.querySelectorAll(".datetime-auto").forEach(el => {
        const ts = el.dataset.timestamp || el.getAttribute("data-timestamp");
        if (ts) {
            const d = new Date(parseInt(ts) * 1000);
            el.textContent = d.toLocaleString(lang);
        }
    });

    // ğŸ” å»¶é²æŸ¥è©¢ Steam Level
    document.querySelectorAll(".friend-item").forEach(li => {
        const profileUrl = li.querySelector("a[href*='steamcommunity']").getAttribute("href");
        const match = profileUrl.match(/(\d{17})$/);
        if (!match) return;

        const steamid = match[1];
        fetch(`/steam-level/${steamid}`)
            .then(res => res.json())
            .then(data => {
                if (data.level !== undefined) {
                    const small = li.querySelector("small");
                    const div = document.createElement("div");
                    div.textContent = `{{ _('ç­‰ç´šï¼š') }}` + data.level;
                    small.appendChild(document.createElement("br"));
                    small.appendChild(div);
                }
            })
            .catch(err => {
                console.warn("âŒ ç„¡æ³•å–å¾— Steam ç­‰ç´šï¼š", steamid, err);
            });
    });
});
</script>
{% endblock %}

